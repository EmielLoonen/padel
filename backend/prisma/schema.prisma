// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  name          String
  phone         String?
  avatarUrl     String?  @map("avatar_url") // URL or path to avatar image
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  createdSessions      Session[]      @relation("SessionCreator")
  rsvps                RSVP[]
  notifications        Notification[]
  addedGuests          Guest[]
  matchesAsTeam1Player1 Match[]       @relation("Team1Player1")
  matchesAsTeam1Player2 Match[]       @relation("Team1Player2")
  matchesAsTeam2Player1 Match[]       @relation("Team2Player1")
  matchesAsTeam2Player2 Match[]       @relation("Team2Player2")
  createdMatches       Match[]        @relation("MatchCreator")

  @@map("users")
}

model Session {
  id                      String   @id @default(uuid())
  date                    DateTime
  time                    String   // Stored as "HH:MM" string (primary court time)
  venueName               String   @map("venue_name")
  venueAddress            String?  @map("venue_address")
  totalCost               Decimal? @map("total_cost") @db.Decimal(10, 2)
  notes                   String?
  numberOfCourts          Int      @default(1) @map("number_of_courts")
  createdById             String   @map("created_by_id")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  creator                 User           @relation("SessionCreator", fields: [createdById], references: [id])
  courts                  Court[]
  rsvps                   RSVP[]
  notifications           Notification[]

  @@index([date, time])
  @@index([createdById])
  @@map("sessions")
}

model Court {
  id                      String   @id @default(uuid())
  sessionId               String   @map("session_id")
  courtNumber             Int      @map("court_number")
  startTime               String   @map("start_time") // "HH:MM"
  duration                Int      @default(60) // minutes
  maxPlayers              Int      @default(4) @map("max_players")
  cost                    Decimal? @db.Decimal(10, 2) // Cost for this specific court
  createdAt               DateTime @default(now()) @map("created_at")

  // Relations
  session                 Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  rsvps                   RSVP[]
  guests                  Guest[]
  matches                 Match[]

  @@unique([sessionId, courtNumber])
  @@index([sessionId])
  @@map("courts")
}

model Guest {
  id                      String   @id @default(uuid())
  courtId                 String   @map("court_id")
  name                    String
  addedById               String   @map("added_by_id")
  createdAt               DateTime @default(now()) @map("created_at")

  // Relations
  court                   Court    @relation(fields: [courtId], references: [id], onDelete: Cascade)
  addedBy                 User     @relation(fields: [addedById], references: [id], onDelete: Cascade)

  @@index([courtId])
  @@index([addedById])
  @@map("guests")
}

model RSVP {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  userId    String   @map("user_id")
  courtId   String?  @map("court_id") // null = waitlist or "maybe"/"no" status
  status    String   // yes, no, maybe
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  court     Court?   @relation(fields: [courtId], references: [id], onDelete: SetNull)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@index([courtId])
  @@map("rsvps")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   // new_session, rsvp_change, booking_update, reminder
  title     String
  message   String
  sessionId String?  @map("session_id")
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  session   Session? @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

model Match {
  id                String   @id @default(uuid())
  courtId           String   @map("court_id")
  team1Player1Id    String   @map("team1_player1_id")
  team1Player2Id    String   @map("team1_player2_id")
  team2Player1Id    String   @map("team2_player1_id")
  team2Player2Id    String   @map("team2_player2_id")
  sets              String   // JSON array of sets: [{"team1": 6, "team2": 4}, {"team1": 6, "team2": 3}]
  createdById       String   @map("created_by_id")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  court             Court    @relation(fields: [courtId], references: [id], onDelete: Cascade)
  team1Player1      User     @relation("Team1Player1", fields: [team1Player1Id], references: [id])
  team1Player2      User     @relation("Team1Player2", fields: [team1Player2Id], references: [id])
  team2Player1      User     @relation("Team2Player1", fields: [team2Player1Id], references: [id])
  team2Player2      User     @relation("Team2Player2", fields: [team2Player2Id], references: [id])
  createdBy         User     @relation("MatchCreator", fields: [createdById], references: [id])

  @@index([courtId])
  @@index([createdById])
  @@index([team1Player1Id])
  @@index([team1Player2Id])
  @@index([team2Player1Id])
  @@index([team2Player2Id])
  @@map("matches")
}

